# **Sequelize2OpenAPI Documentation**

## Overview

**Sequelize2OpenAPI** is a tool that automatically generates OpenAPI specifications (formerly Swagger) for Express.js
API applications by analyzing annotations directly written in Sequelize models. This allows developers to maintain API
documentation alongside their data models, ensuring consistency and reducing documentation overhead.

## Installation

*Disclaimer*: This package is still under development and is not yet published on npmjs.

## Configuration

Create a configuration file named `sequelize2openapi.json` in your project root with the following structure:

```json
{
    "openApiDefinition": {
        "openapi": "3.0.0",
        "info": {
            "title": "OpenAPI specs",
            "description": "OpenAPI specifications generator with Sequelize",
            "contact": {
                "name": "Hasininjato Rojovao"
            },
            "version": "1.0.0"
        },
        "servers": [
            {
                "url": "http://localhost:8000/api"
            },
            {
                "url": "http://localhost:3000/api"
            }
        ]
    },
    "servicesPath": "./app/docs/services",
    "modelsPath": "./app/models",
    "defaultSecurity": "jwt",
    "routePrefix": "/api"
}
```

### Configuration Options

- **openApiDefinition**: Base OpenAPI specification that will be extended with your model definitions
    - **openapi**: OpenAPI version
    - **info**: Metadata about your API
        - **title**: Title of your project
        - **description**: Description of your project
        - **contact**: Contact info about the maintainers of the project
    - **servers**: Array of server URLs where the API is hosted
- **servicesPath**: Path to where service files (based on models) are stored
- **modelsPath**: Folder containing your Sequelize models
- **defaultSecurity**: Default security scheme for API endpoints (e.g., "jwt") (@todo: in progress)
- **routePrefix**: Prefix for all API routes (e.g., "/api")

## Usage

### Basic Integration

In your Express.js application:

```javascript
const sequelize2openapi = require('sequelize2openapi');
const swaggerUi = require('swagger-ui-express');

try {
    const swaggerSpec = sequelize2openapi(app);
    app.use('/docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));
} catch (err) {
    throw err;
}
```

### CLI Tool

This package also includes a CLI tool that generates a default service file for a model:

```bash
sequelize2openapi -m Model
```

where Model is your Sequelize model name.

This creates a service file called `model.yaml` in your `servicesPath` with default content for the specified model
like:

```yaml
Model:
  collectionOperations:
    get:
      openapi_context:
        summary: "List of all models"
        description: "List of all models"
      output:
        - "model:list"
    post:
      openapi_context:
        summary: "Create a model"
        description: "Create a model"
      input:
        - "model:post"
      output:
        - "model:item"
  itemOperations:
    get:
      openapi_context:
        summary: "Get model by id"
        description: "Get model by id"
      output:
        - "model:item"
    put:
      openapi_context:
        summary: "Update a model by id"
        description: "Update a model by id"
      input:
        - "model:put"
      output:
        - "model:item"
    delete:
      openapi_context:
        summary: "Delete a model by id"
        description: "Delete a model by id"
```

We will see the structure of this service file later.

## Model Annotations

You need to annotate your Sequelize models fields with a structured comment, by adding `@swag`

```js
const Model = sequelize.define('Model', {
    /**
     * @swag
     * description: Model ID
     * methods: list, item
     */
    id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER
    },
    /**
     * @swag
     * description: Model description
     * methods: list, item, put, post
     */
    description: DataTypes.TEXT
});
```

### Annotation Options

| Field         | Description                                                                                                              |
|---------------|--------------------------------------------------------------------------------------------------------------------------|
| `description` | Appears in API docs as the field description                                                                             |
| `methods`     | Determines which CRUD or custom operations this field applies to, this will be used in your service file for your models |

## Service Files & Custom Operations

### Standard CRUD Example

This is the default CRUD operations generated by the CLI tool `sequelize2openapi -m Model`.

```yaml
ModelName:
  collectionOperations:
    get:
      openapi_context:
        summary: "List items"
      output: [ "model:list" ]

    post:
      openapi_context:
        summary: "Create item"
      input: [ "model:post" ]
      output: [ "model:item" ]

  itemOperations:
    get:
      openapi_context:
        summary: "Get item by ID"
      output: [ "model:item" ]

    put:
      openapi_context:
        summary: "Update item"
      input: [ "model:put" ]
      output: [ "model:item" ]

    delete:
      openapi_context:
        summary: "Delete item"
```

#### Services file options

The file begins with the name of the Sequelize model. Then, you have two types of operations:

- **collectionOperations**: collection operations represent operations that apply to a collection of resources (for
  example, `/api/books`).
- **itemOperations**: item operations represent operations that apply to a specific instance of resources (for example,
  `/api/books/1`).
- **openapi_context**: definition of OpenAPI documentation metadata (`description` and `summary`)
- **input**: specifies the validation groups for the request payload. This value follows the structure `model:method`,
  where `method` is one of the `methods` values listed in your models annotations. This option is only for creation or
  update endpoint (POST, PATCH or PUT).
- **output**: specifies the serialization groups for the response. The value follows the same structure as `input`. This
  option allows to return data to client with status code 200 or 201.
- **isCreation**: optional for `POST` method. It specifies whether the operation creates a resource or is only used to
  send data via form (like search). If not specified (for POST default operation, it is set to true), otherwise you
  need to specify it. This option is useful to properly return responses for POST operation.

### Custom Route Example

In addition, of the default operations, you can create your own (custom) operations like:

```yaml
collectionOperations:
  login:
    tags:
      - name: "Authentication"
        description: "Authenticate user with email and password"
    path: "/auth/login"
    method: "POST"
    openapi_context:
      summary: "Login"
      description: "Authenticate user"
      responses:
        401:
          description: "Invalid credentials"
    isCreation: false
    input:
      - "user:login"
    output:
      - "user:login"
      - custom:
          - name: "access_token"
            description: "Access token"
```

#### Services file options

The custom operation begins with its name (example `login`).
In addition of default operations, you need to specify:

- **tags**: used to group related operations together in the documentation. Tags for default operations are set to the
  name of the model, but you can specify it.
- **path**: path of the endpoint of your operation, without the prefix (if you add prefix to your API endpoints).
- **responses**: it is declared inside the openapi_context, and used to list custom responses of your endpoint instead
  of the default ones.

#### Custom output

#### Default responses

Responses are generated based on the output values.

- For POST creation of a resource (or isCreation is set to true), responses are 201 Created, 400 Bad Request (with
  errors details automatically generated based on your Sequelize configurations), 